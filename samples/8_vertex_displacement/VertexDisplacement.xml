<?xml version="1.0"?>

<effect>
  <include name="lighting.xml"/>
  <shader type="vertex_shader" name="VertexDisplacementVS">
    <attrib  name="pos" usage="position"/>
    <attrib  name="normal" usage="normal"/>
    <uniform type="vec3" name="pos_extent"/>
    <uniform type="vec3" name="pos_center"/>

    <code>
      <![CDATA[
in vec3 pos;
in vec2 uv;

uniform vec3 pos_extent;
uniform vec3 pos_center;

uniform float half_length;
uniform float half_width;
uniform float angle;

out vec3 pass_normal;
out vec2 pass_uv;

void main()
{
  vec3 world_pos = pos * pos_extent + pos_center;
  
  vec2 offset = pos.xy + vec2(half_length, -half_width);
  world_pos.z = (cos(offset.x + angle) + sin(offset.y + angle)) * offset.x * 0.2f;
  
  vec3 tan_dir = vec3(0.5f, 0, -sin(pos.x + angle) * 0.2f;
  vec3 y_dir = vec3(0, 0.5f, cos(pos.y + angle) * pos.x * 0.2f;
  vec3 normal = model_view * cross(x_dir, y_dir);

  gl_Position = mvp * vec4(world_pos, 1.0f);
  pass_normal = normal;
  pass_uv = uv;
}
      ]]>
    </code>
  </shader>
</effect>